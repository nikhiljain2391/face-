<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>HDFC Life</title>
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="shortcut icon" href="images/favicon.ico">
<link rel="stylesheet" href="css/bootstrap.min.css">
<link rel="stylesheet" href="css/style.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script>
	function openBrowse(){
		localStorage.removeItem("image_url");
		localStorage.removeItem("age");
		localStorage.removeItem("gender");
		localStorage.removeItem("premium");
		localStorage.removeItem("term");
		document.getElementById('capture').click();
	}



	function handleChange(event){
		var reader = new FileReader();
    if(event.target.files && event.target.files[0]){
      reader.readAsDataURL(event.target.files[0]); // read file as data url
        //this.fileChange(event);
        reader.onload = (event) => { // called once readAsDataURL is completed

					var tempImg = new Image();
          tempImg.src = reader.result;
          tempImg.onload = function() {
         		var MAX_WIDTH = 700;
            var MAX_HEIGHT = 600;
            var tempW = tempImg.width;
            var tempH = tempImg.height;
						var iOS = !!navigator.platform && /iPad|iPhone|iPod/.test(navigator.platform);
						if(iOS==true){
							var tempW = tempImg.height;
	            var tempH = tempImg.width;
						}

						if (tempW/MAX_WIDTH > tempH/MAX_HEIGHT) {
                if (tempW > MAX_WIDTH) {
                    tempH *= MAX_WIDTH / tempW;
                    tempW = MAX_WIDTH;
                }
            } else {
                if (tempH > MAX_HEIGHT) {
                    tempW *= MAX_HEIGHT / tempH;
                    tempH = MAX_HEIGHT;
                }
            }


            var canvas = document.createElement('canvas');

            canvas.width = tempW;
            canvas.height = tempH;
            var ctx = canvas.getContext("2d");
						ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
						if(iOS==true){
							canvas.width = tempH;
	            canvas.height = tempW;
							ctx.setTransform(0, 1, -1, 0, tempH, 0);
							ctx.drawImage(this, 0, 0, tempW, tempH);
						}else{
							ctx.drawImage(this, 0, 0, tempW, tempH);
						}
						ctx.setTransform(1, 0, 0, 1, 0, 0);
            var dataURL = canvas.toDataURL("image/jpeg");
						$(".loader-container").show()
	          var url = {
							base64 : dataURL
						}
						localStorage.setItem("image_url",dataURL)
	          getImageDetails(url);
          }

          // console.log(url);
        }
    }else{

    }
	}


	function getImageDetails(url){

		axios.post("http://52.66.44.56:3000/getData", url).then(
				response => {
						let res = response.data
						console.log(res)
						if(JSON.stringify(res).indexOf("413 Request Entity Too Large") > -1){
								//dispatch({type: "LARGE_FILE"})
								$(".loader-container").hide()
								$("#banner").hide()
								$("#error").show()
						}else{
								if(res.data.faces){
										if(res.data.faces.length === 0){
											$(".loader-container").hide()
											$("#banner").hide()
											$("#error").show()
										}else{
												let age = res.data.faces[0].attributes.age.value;
												let gender = res.data.faces[0].attributes.gender.value;
												let image_name = res.image_name;
												let term = 65 - parseInt(age);
												localStorage.setItem("term",term);
												localStorage.setItem("age",age)
												localStorage.setItem("gender",gender)
												//window.open("second.html","_self")
												let soap_first= '<?xml version="1.0" encoding="UTF-8"?><SOAP-ENV:Envelope xmlns:ns0="http://schemas.xmlsoap.org/soap/envelope/" xmlns:ns1="http://TEBT_QuoteGeneration/QuoteGeneration_TP" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/"><SOAP-ENV:Header/><ns0:Body><ns1:generatequote><generatequoteReq><head><source>OCP_ONLINE</source><userid>kuliza_ocp_001</userid><txnid>FIN-81989</txnid></head><body><quotedtls><jnk>N</jnk><sumAssured>10000000</sumAssured><term>'+term+'</term><ppt>'+term+'</ppt><freq>FREQ_4</freq><touchpoint>OCP</touchpoint><product>C2P3DPER</product><option>3D Life</option><tobstatus>N</tobstatus><lifeassured>'

												if(gender=="Female"){
													var gender_pre = "GEN_F"
												}else{
													var gender_pre = "GEN_M"
												}

												var dob = "01/01/"+(2018-age)

												let soap_mid='<dob>'+dob+'</dob><gender>'+gender_pre+'</gender>'

												let soal_last = '</lifeassured><pptOption>REGULAR</pptOption></quotedtls><outputFmt>JSON</outputFmt><agentcd>00488538</agentcd><generateonlyflag>Y</generateonlyflag></body></generatequoteReq></ns1:generatequote></ns0:Body></SOAP-ENV:Envelope>'
												// var settings = {
												//   "async": true,
												//   "crossDomain": true,
												//   "url": "http://localhost:3000/getPremium",
												//   "method": "POST"
												// 	"data" : soap_first+soap_mid+soal_last
												// }
												// $.post( "http://124.30.32.37:9082/TEBT_QuoteGenerationWeb/sca/QuoteGeneration_ThirdPartyExport",soap_first+soap_mid+soal_last, function( data ) {
												//   console.log(soap_first+soap_mid+soal_last)
												// });
												// $.ajax(settings).done(function (response) {
												//   console.log(response);
												// });
												let reqData = {
													"data" : soap_first+soap_mid+soal_last
												}
												console.log(reqData)
												axios.post("http://52.66.44.56:3000/getPremium", reqData).then(
														response => {
																//let res = JSON.parse(response);
																if(response.data.totPremium==undefined){
																	$(".loader-container").hide()
																	$("#banner").hide()
																	$("#error").show()
																}else{
																		localStorage.setItem("premium",response.data.totPremium)
																		window.open("second.html","_self")
																}
															}).catch(err => {
																	console.log(err);
																	$(".loader-container").hide()
																	$("#banner").hide()
																	$("#error").show()
																	//dispatch({type: "NO_DATAS"});
															})
										}
								}else{
										console.log("No Face found");
										$(".loader-container").hide()
										$("#banner").hide()
										$("#error").show()
										//dispatch({type: "TECH_ERROR"});
								}
						}
				}
		).catch(err => {
				console.log(err);
				$(".loader-container").hide()
				$("#banner").hide()
				$("#error").show()
				//dispatch({type: "NO_DATAS"});
		})
	}
</script>
</head>

<body>
	<header>
		<div class="container">
			<div class="text-left">
				<a href="#"><img src="images/logo.svg" alt="logo" /></a>
			</div>
		</div>
	</header>
	<section class="banno">
		<div class="container">
			<img src="images/ban1.png" id="banner" class="img-responsive text-center" alt="banner"/>
			<img src="images/error.png" id="error" style="display:none" class="img-responsive text-center" alt="banner"/>
			<a href="#" class="cambtn">
				<img src="images/cambtn.svg" alt="camera" onclick="openBrowse()">
				<input type="file" accept="image/*" id="capture" capture="camera" style="display:none" onChange="handleChange(event)"/>
			</a>
			<p class="despiko text-center" style="margin-top:32px">Before you say cheese, make sure Your face is well-lit. Hair strands are pushed to the back.
You are not wearing glasses.</p>
			<h1><strong>UPLOAD A SELFIE</strong> <span class="thin">& GET AN INSURANCE QUOTE</span></h1>
			<p class="despiko text-center">A look at this selfie after years and you would know that you did the right thing! So, what are you waiting for? <strong>Carpe Diem!</strong></p>
			<a class="calltoact"  onclick="openBrowse()">Get My Quote <img src="images/right-arrow.svg" width="16" alt="" class="arrow" /></a>
		</div>
	</section>
	<div class="loader-container">
		<div class="loader">
			<img src="images/loader.gif" alt="loader" class="img-responsive">
		</div>
	</div>
</body>
</html>
